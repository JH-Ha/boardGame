<!DOCTYPE html>
<html lang="kr">

<head>
    <meta charset="UTF-8" />
    <title>minesweeper</title>
    <link rel="stylesheet" href="style.css" />
    <script>
        class Tile {
            constructor(x, y, isOpen, isMine) {
                this.x = x;
                this.y = y;
                this.isOpen = isOpen;
                this.isMine = isMine;
                this.priority = 0;
                this.isFlag = false;
            }
        }
        let tileArr = [];
        let dx = [0, 1, 0, -1];
        let dy = [1, 0, -1, 0];
        let numRow = 9;
        let numCol = 9;
        let numMine = 10;
        let isStarted = false;
        let isEnded = false;
        let notOpen = numRow * numCol;
        let colorMap = {
            1: "one",
            2: "two",
            3: "three",
            4: "four",
            5: "five",
            6: "six",
            7: "seven",
            8: "eight"
        };
        let startTime = 0;
        let intervalId = -1;
        let leftMine = numMine;

        function toStringLeadingZero(num, targetLength) {
            let str = num + '';
            while (str.length < targetLength) {
                str = '0' + str;
            }
            return str;
        }
        function toggleFlag(x, y, item) {
            if (tileArr[x][y].isOpen) {
                return;
            }
            let itemContent = item.querySelector(".item-content");
            if (tileArr[x][y].isFlag) {
                tileArr[x][y].isFlag = false;
                itemContent.innerHTML = "";
                item.classList.remove("flag");
                leftMine++;
            } else {
                tileArr[x][y].isFlag = true;
                let img = document.createElement("img");
                img.classList.add("bomb");
                img.src = "./flag.png";
                itemContent.append(img);
                item.classList.add("flag");
                leftMine--;
            }
            setContext('left-mine', toStringLeadingZero(leftMine, 3));
        }
        function clickTile(e) {
            let isRightMB = false;
            let item = this;
            if ("which" in e) { // Gecko (Firefox), WebKit (Safari/Chrome) & Opera
                isRightMB = e.which == 3;
                for (let i = 0; i < e.path.length; i++) {
                    if (e.path[i].classList.contains("item")) {
                        item = e.path[i];
                        break;
                    }
                }


            }
            let x = parseInt(item.dataset.x);
            let y = parseInt(item.dataset.y);
            if (isRightMB) {
                toggleFlag(x, y, item);
                return;
            }
            //To prevent start game
            if (tileArr[x][y].isFlag) {
                return;
            }
            if (!isStarted) {
                setMine(x, y);
                isStarted = true;
                isEnded = false;
                startTime = new Date();
                setContext('time', '000');

                intervalId = setInterval(() => {
                    let curTime = new Date();
                    let timeDiff = Math.floor((curTime - startTime) / 1000) + '';
                    while (timeDiff.length < 3) {
                        timeDiff = '0' + timeDiff;
                    }
                    setContext('time', timeDiff);
                    if (isEnded) {
                        clearInterval(intervalId);
                    }
                }, 100);
            }
            open(x, y);
        }
        function isValid(x, y, n, m) {
            if (x >= 0 && x < n && y >= 0 && y < m) {
                return true;
            }
            return false;
        }
        function openAll() {
            for (let i = 0; i < numRow; i++) {
                for (let j = 0; j < numCol; j++) {
                    open(i, j);
                }
            }
        }
        function getItem(i, j) {
            return document.querySelector(`.item[data-x='${i}'][data-y='${j}']`);
        }
        function flagAll() {
            for (let i = 0; i < numRow; i++) {
                for (let j = 0; j < numCol; j++) {
                    if (!tileArr[i][j].isOpen && !tileArr[i][j].isFlag) {
                        let item = getItem(i, j);
                        toggleFlag(i, j, item);
                    }
                }
            }
        }
        function open(x, y) {
            //After end game, stop working of open
            if (tileArr[x][y].isOpen || tileArr[x][y].isFlag) {
                return;
            }
            tileArr[x][y].isOpen = true;

            let item = document.querySelector(`.item[data-x='${x}'][data-y='${y}'`);
            item.classList.add("open");
            let itemContent = item.querySelector(".item-content");
            if (tileArr[x][y].isMine) {
                let img = document.createElement("img");
                img.classList.add("bomb");
                img.src = "./bomb.png";
                itemContent.append(img);

                if (!isEnded) {
                    isEnded = true;
                    item.classList.add("red");
                    openAll();
                    showModal("Game Over");
                }
            } else {
                itemContent.textContent = tileArr[x][y].content;
                if (tileArr[x][y].num != 0)
                    itemContent.classList.add(colorMap[tileArr[x][y].num]);
            }

            //check victory

            if (!isEnded) {
                let leftOpen = 0;
                for (let i = 0; i < numRow; i++) {
                    for (let j = 0; j < numCol; j++) {
                        if (!tileArr[i][j].isOpen) {
                            leftOpen++;
                        }
                    }
                }
                if (leftOpen == numMine) {
                    showModal("Victory");
                    flagAll();
                    isEnded = true;
                }
            }
            if (tileArr[x][y].num == 0) {
                for (let nextX = x - 1; nextX <= x + 1; nextX++) {
                    for (let nextY = y - 1; nextY <= y + 1; nextY++) {
                        if (isValid(nextX, nextY, numRow, numCol) && !tileArr[nextX][nextY].isOpen) {
                            open(nextX, nextY);
                        }
                    }
                }
            }
        }
        function setMine(ignoreX, ignoreY) {

            let mineArr = [];
            for (let i = 0; i < numRow; i++) {
                for (let j = 0; j < numCol; j++) {
                    if (i == ignoreX && j == ignoreY) {
                        continue;
                    }
                    tileArr[i][j].priority = Math.random();
                    mineArr.push(tileArr[i][j]);
                }
            }
            mineArr.sort((a, b) => {
                return (a.priority - b.priority);
            });

            for (let i = 0; i < numMine; i++) {
                mineArr[i].isMine = true;
            }
            //calculate number
            for (let i = 0; i < numRow; i++) {
                for (let j = 0; j < numCol; j++) {
                    let num = 0;
                    for (let x = i - 1; x <= i + 1; x++) {
                        for (let y = j - 1; y <= j + 1; y++) {
                            if (isValid(x, y, numRow, numCol) && tileArr[x][y].isMine) {
                                num++;
                            }
                        }
                    }
                    tileArr[i][j].num = num;
                    if (num != 0) {
                        tileArr[i][j].content = num;
                    }
                }
            }
        }
        function setContext(id, context) {
            let node = document.getElementById(id);
            if (node !== undefined) {
                node.textContent = context
            }
        }
        function showModal(content) {
            let modalBackground = document.getElementById("modal-background");
            let modalContent = document.getElementById("modal-content");
            modalBackground.classList.add("show");
            modalContent.textContent = content;

        }
        function closeModal() {
            let modalBackground = document.getElementById("modal-background");
            modalBackground.classList.remove("show");
        }
        function resetGame() {
            initGame();
            clearInterval(intervalId);
        }
        function initGame() {
            let board = document.getElementById("board");
            board.innerHTML = "";
            tileArr = [];
            isStarted = false;
            isEnded = false;
            setContext('left-mine', toStringLeadingZero(numMine, 3));
            setContext('time', '000');
            leftMine = numMine;
            //disalbe showing menu when click right mouse button
            board.oncontextmenu = function (e) {
                console.log(e);
                clickTile(e);
                return false;
            }
            let rowContainer = document.createElement("div");
            rowContainer.classList.add("row-container");

            for (let i = 0; i < numRow; i++) {
                let row = document.createElement("div");
                row.classList.add("row");
                let tileRow = [];
                for (let j = 0; j < numCol; j++) {
                    let item = document.createElement("div");
                    item.classList.add("item");
                    item.dataset.x = i;
                    item.dataset.y = j;
                    item.addEventListener("click", clickTile);
                    let itemContent = document.createElement("div");
                    itemContent.classList.add("item-content");
                    item.append(itemContent);
                    row.append(item);
                    tileRow.push(new Tile(i, j, false, false));
                }
                tileArr.push(tileRow);
                rowContainer.append(row);
            }
            board.append(rowContainer);

            //modal setting
            let modalClose = document.getElementById("modal-close");
            modalClose.addEventListener("click", function () {
                console.log("close");
                closeModal();
            });
        }
        document.addEventListener("DOMContentLoaded", function () {
            initGame();

            let resetBtn = document.getElementById("reset-btn");
            resetBtn.addEventListener("click", () => {
                resetGame();
            });
        }); 
    </script>
</head>

<body>
    <div id="container">
        <div id="title">Minesweeper</div>
        <div id="top-bar">
            <div id="left-mine">000</div>
            <button id="reset-btn">reset</button>
            <div id="time">000</div>
        </div>
        <div id="board">

        </div>
    </div>
    <div id="modal-background">
        <div id="modal">
            <div id="modal-head">
                <div id="modal-close">×
                </div>
            </div>
            <div id="modal-content">
                Game Over
            </div>
        </div>
    </div>
</body>

</html>