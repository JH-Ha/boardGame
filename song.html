<html>

<head>
    <style>
        #board {
            border: 4px solid pink;
            border-radius: 4px;
            width: 400px;
            height: 400px;
            border-spacing: 0px;
        }

        #board td {
            border: 4px solid pink;
        }

        .clear {
            clear: both;
        }

        #item-1 {
            border-radius: 4px;
            border: 4px solid coral;
            width: 90px;
            height: 90px;
            position: absolute;
            top: 4px;
            left: 4px;
        }

        .tile {
            border-radius: 4px;
            border: 4px solid blueviolet;
            width: 90px;
            height: 90px;
            position: absolute;
            top: 4px;
            left: 4px;
            text-align: center;
            line-height: 90px;
            ;
        }

        #content {
            position: relative;
        }
    </style>
    <script>
        class BoardTiles {
            constructor() {
                this.width = 4;
                this.height = 4;
                this.numEmpty = this.width * this.height;
                this.tileArray = null;
                this.init();

            }
            init() {
                this.tileArray = Array();


                let i, j;
                for (i = 0; i < this.height; i++) {
                    this.tileArray[i] = Array();
                }

                for (i = 0; i < this.width; i++) {
                    for (j = 0; j < this.height; j++) {
                        let left = 4 + 98 * i;
                        let top = 4 + 98 * j;
                        let empty = true;
                        this.tileArray[i][j] = new BoardTile(left, top, empty, i, j);
                        this.tileArray[i][j].print();
                    }
                }

            }
            printAll() {
                let i, j;
                console.log(`numEmpty : ${this.numEmpty}`);
                for (i = 0; i < this.width; i++) {
                    for (j = 0; j < this.height; j++) {
                        this.tileArray[i][j].print();
                    }
                }
            }
            getTile(x, y) {
                return this.tileArray[x][y];
            }
            moveRight() {
                console.log(`moveRight called`);
                let i, j;
                let rightEmptyIdx = -1;
                for (j = 0; j < this.height; j++) {
                    if (this.tileArray[this.width - 1][j].empty == false && this.tileArray[this.width - 2][j].empty == true && this.tileArray[this.width - 3][j].empty == false) {
                        if (this.tileArray[this.width - 1][j].value == this.tileArray[this.width - 3][j].value) {
                            this.actionTile(this.width - 1, this.width - 3, j, 'x-right');
                        }
                    }
                    if (this.tileArray[this.width - 1][j].empty == false && this.tileArray[this.width - 2][j].empty == true && this.tileArray[this.width - 3][j].empty == true && this.tileArray[this.width - 4][j].empty == false) {
                        if (this.tileArray[this.width - 1][j].value == this.tileArray[this.width - 4][j].value) {
                            this.actionTile(this.width - 1, this.width - 4, j, 'x-right');
                        }
                    }

                    for (i = this.width - 1; i >= 1; i--) {
                        if (this.tileArray[i][j].empty == false && this.tileArray[i - 1][j].empty == false) {
                            if (this.tileArray[i][j].value == this.tileArray[i - 1][j].value) {
                                this.actionTile(i - 1, i, j, 'x-right');
                                // this.tileArray[i - 1][j].empty = true;
                                // this.numEmpty++;
                                // this.tileArray[i][j].value *= 2;
                                // rightEmptyIdx = this.findEmptyIdx('x-right', i, j);
                                // this.removeTile(i, j);
                                // this.removeTile(i - 1, j);
                                // if (rightEmptyIdx != -1) {
                                //     this.createTile(rightEmptyIdx, j, this.tileArray[i][j].value);
                                // }
                            }
                        }
                    }

                    for(i = this.width -1 ; i>=0 ; i--){
                        if(this.tileArray[i][j].empty == false){
                            this.actionOneTile(i,j,'x-right');
                        }
                    }

                }

            }
            actionOneTile(idx1, stdAxisIdx, direction) {
                let tileId1 = this.makeTileId(idx1, stdAxisIdx);
                var $tile1 = document.getElementById(tileId1);
                let emptyIdx = -1;
                let nextValue = this.tileArray[idx1][stdAxisIdx].value;
                if (direction == 'x-right') {
                    emptyIdx = this.findEmptyIdx('x-right', idx1, stdAxisIdx);
                    if(emptyIdx == -1){
                        return;
                    }
                    let xPosStartTile1 = this.tileArray[idx1][stdAxisIdx].left;
                    let xPosEndTile1 = this.tileArray[emptyIdx][stdAxisIdx].left;
                    let xIdxEndTile1 = this.tileArray[emptyIdx][stdAxisIdx].x;
                    let diffX1 = xPosEndTile1 - xPosStartTile1;

                    var player = $tile1.animate([
                        { transform: 'translate(0)' },
                        { transform: `translate(${diffX1}px,0px)` }
                    ], 100);
                    player.addEventListener('finish', function () {
                        $tile1.style.left = `${xPosEndTile1}px`;
                        $tile1.setAttribute('x', xIdxEndTile1);
                    });

                    var objThis = this;
                    this.tileArray[idx1][stdAxisIdx].empty = true;
                    setTimeout(function () {
                        objThis.removeTile(idx1, stdAxisIdx);
                    }, 100);
                    if (emptyIdx != -1) {
                        this.tileArray[idx1][stdAxisIdx].value = 0;
                        this.createTile(emptyIdx, stdAxisIdx, nextValue);
                        console.log(`idx1 value !!! ${this.tileArray[idx1][stdAxisIdx].value } emptyIdx : ${emptyIdx}`);
                    }


                }


            }
            //idx1 first index of tile, idx2 : second idx of tile
            //stdAxisIdx is standard index of idx1 tile and idx2 tile
            //for example (1,3) (2,3) => idx1 = 1 idx2 = 2 stdAxisIdx = 3
            actionTile(idx1, idx2, stdAxisIdx, direction) {
                this.tileArray[idx1][stdAxisIdx].empty = true;
                //net empty tile is +1, remove 2 tiles and create 1 tile;
                this.numEmpty++;
                let nextValue = this.tileArray[idx1][stdAxisIdx].value *2;
                //this.tileArray[idx2][stdAxisIdx].value *= 2;
                let emptyIdx = this.findEmptyIdx(direction, idx2, stdAxisIdx);
                if(emptyIdx == -1){
                    if(direction == 'x-right'){
                        emptyIdx = idx2;
                    }
                }
                console.log(`idx1: ${idx1}, dix2: ${idx2}, stdAxisIdx: ${stdAxisIdx} emptyIdx ${emptyIdx}`);
                let tileId1 = this.makeTileId(idx1, stdAxisIdx);
                let tileId2 = this.makeTileId(idx2, stdAxisIdx);
                var $tile1 = document.getElementById(tileId1);
                var $tile2 = document.getElementById(tileId2);

                let xPosStartTile1 = this.tileArray[idx1][stdAxisIdx].left;
                let xPosEndTile1 = this.tileArray[emptyIdx][stdAxisIdx].left;
                let xIdxEndTile1 = this.tileArray[emptyIdx][stdAxisIdx].x;

                let xPosStartTile2 = this.tileArray[idx2][stdAxisIdx].left;
                let xPosEndTile2 = this.tileArray[emptyIdx][stdAxisIdx].left;
                let xIdxEndTile2 = this.tileArray[emptyIdx][stdAxisIdx].x;

                let diffX1 = xPosEndTile1 - xPosStartTile1;
                let diffX2 = xPosEndTile2 - xPosStartTile2;
                
                var player = $tile1.animate([
                    { transform: 'translate(0)' },
                    { transform: `translate(${diffX1}px,0px)` }
                ], 100);
                player.addEventListener('finish', function () {
                    $tile1.style.left = `${xPosEndTile1}px`;
                    $tile1.setAttribute('x', xIdxEndTile1);
                });

                var player2 = $tile2.animate([
                    { transform: 'translate(0)' },
                    { transform: `translate(${diffX2}px,0px)` }
                ], 100);
                player2.addEventListener('finish', function () {
                    $tile2.style.left = `${xPosEndTile2}px`;
                    $tile2.setAttribute('x', xIdxEndTile2);
                });


                var objThis = this;
                this.tileArray[idx1][stdAxisIdx].empty = true;
                this.tileArray[idx2][stdAxisIdx].empty = true;
                setTimeout(function () {
                    objThis.removeTile(idx2, stdAxisIdx);
                    objThis.removeTile(idx1, stdAxisIdx);
                }, 100);
                if (emptyIdx != -1) {
                    this.tileArray[idx1][stdAxisIdx].value = 0;
                    this.tileArray[idx2][stdAxisIdx].value = 0;
                    this.createTile(emptyIdx, stdAxisIdx, nextValue );
                }
            }
            findEmptyIdx(direction, startX, startY) {
                let i, j;
                if (direction == 'x-right') {
                    for (i = this.width - 1; i >= 0; i--) {
                        if (i < startX){
                            return -1;
                        }
                        if (startX == this.width - 1) {
                            return startX;
                        }
                        if (this.tileArray[i][startY].empty == true) {
                            return i;
                        }
                    }
                }
                else if (direction == 'x-left') {
                    for (i = 0; i < this.width; i++) {
                        if (startX == 0) {
                            return startX;
                        }
                        if (this.tileArray[i][startY].empty == true) {
                            return i;
                        }
                    }
                }
                return -1;
            }
            createTile(x, y, val) {
                this.numEmpty--;
                this.tileArray[x][y].empty = false;
                this.tileArray[x][y].value = val;
                let tileList = document.getElementById('tile-list');
                let node = document.createElement('div');
                node.innerHTML = val;
                node.style.left = 4 + x * 98;
                node.style.top = 4 + y * 98;
                node.classList.add('tile');
                node.id = this.makeTileId(x, y);
                tileList.appendChild(node);
            }
            makeTileId(x, y) {
                return `tile-${x}-${y}`;
            }
            removeTile(x, y) {
                //this.tileArray[x][y].empty = true;
                let tileId = this.makeTileId(x, y);
                let tileList = document.getElementById('tile-list');
                let node = document.getElementById(tileId);
                tileList.removeChild(node);
            }

        }
        class BoardTile {
            constructor(left, top, empty, x, y) {
                this.left = left; //int
                this.top = top; //int
                this.empty = empty; //boolean
                this.value = 0;
                this.x = x;
                this.y = y;
            }
            print() {
                console.log(`${this.left}, ${this.top}, ${this.empty}, x: ${this.x}, y: ${this.y}`);
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            var boardTiles = new BoardTiles();
            boardTiles.createTile(0, 1, 2);
            //boardTiles.createTile(1, 1, 1);
            boardTiles.createTile(2, 1, 2);
            boardTiles.createTile(3, 1, 4);
            boardTiles.createTile(1,2,1);
            boardTiles.printAll();


            var $item1 = document.getElementById("item-1");
            document.onkeydown = function (event) {
                var x = parseInt($item1.getAttribute('x'));
                var y = parseInt($item1.getAttribute('y'));
                let nextLeft = boardTiles.getTile(x + 1, y).left;
                console.log(`nextLeft ${nextLeft}`);
                console.log(`sytle x ${$item1.getAttribute('x')}`);

                console.log(`random number = ${parseInt(Math.random() * 4)}`);
                console.log(event.keyCode);
                if (event.keyCode == 39) {//오른쪽 키보드
                    boardTiles.moveRight();
                    // boardTiles.printAll();
                    // var player = $item1.animate([
                    //     { transform: 'translate(0)' },
                    //     { transform: `translate(98px,0px)` }
                    // ]
                    //     , 100);
                    // player.addEventListener('finish', function () {
                    //     $item1.style.left = `${nextLeft}px`;
                    //     $item1.setAttribute('x', x + 1);
                    // });
                }
                else if (event.keyCode == 38) {//위쪽 키보드

                }
                else if (event.keyCode == 37) {//왼쪽 키보드

                }
                else if (event.keyCode == 40) {//아래쪽 키보드

                }
            };
        });

    </script>

</head>

<body>

    <div id="content">
        <table id="board">
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
        <div id="tile-list">
            <div id="item-1" x="0" y="0"></div>
        </div>
    </div>
</body>

</html>